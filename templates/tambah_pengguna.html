{% extends "layout.html" %}

{% block title %}Urus Pengguna{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h2">Urus Pengguna</h1>
</div>

<div class="row">
    <div class="col-lg-4 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-user-plus me-2"></i>Tambah Pengguna Baru</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('tambah_pengguna') }}">
                    <div class="mb-3">
                        <label for="nama" class="form-label">Nama Penuh</label>
                        <input type="text" class="form-control" id="nama" name="nama" required>
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="telefon" class="form-label">Nombor Telefon</label>
                        <input type="tel" class="form-control" id="telefon" name="telefon">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="peranan" class="form-label">Peranan</label>
                        <select class="form-select" id="peranan" name="peranan" required>
                            <option value="" disabled selected>Pilih Peranan</option>
                            <option value="admin">Admin</option>
                            <option value="sales">Sales</option>
                            <option value="designer">Designer</option>
                            <option value="production">Production</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100"><i class="fas fa-plus me-2"></i>Tambah Pengguna</button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-8 mb-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i>Senarai Pengguna Sedia Ada</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Nama</th>
                                <th>Peranan</th>
                                <th>Target Jualan (RM)</th>
                                <th class="text-center">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for p in pengguna %}
                            <tr>
                                <td>
                                    <strong>{{ p.nama }}</strong><br>
                                    <small class="text-muted">{{ p.username }}</small>
                                </td>
                                <td><span class="badge bg-info text-dark">{{ p.peranan | title }}</span></td>
                                <td>
                                    {% if p.peranan == 'sales' %}
                                    <form method="POST" action="{{ url_for('kemaskini_target_jualan') }}">
                                        <div class="input-group input-group-sm">
                                            <input type="hidden" name="pengguna_id" value="{{ p.id }}">
                                            <input type="number" step="100" class="form-control" name="target_jualan" value="{{ p.target_jualan or 0 }}" placeholder="0.00">
                                            <button type="submit" class="btn btn-outline-secondary"><i class="fas fa-save"></i></button>
                                        </div>
                                    </form>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <div class="btn-group">
                                        <button type="button" class="btn btn-outline-secondary btn-sm"
                                                data-bs-toggle="modal" data-bs-target="#detailPenggunaModal"
                                                data-pengguna-id="{{ p.id }}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        {% if p.peranan != 'admin' %}
                                        <form method="POST" action="{{ url_for('padam_pengguna', pengguna_id=p.id) }}" class="d-inline" onsubmit="return confirm('Anda pasti mahu padam pengguna {{ p.username }}?');">
                                            <button type="submit" class="btn btn-danger btn-sm" title="Padam"><i class="fas fa-trash-alt"></i></button>
                                        </form>
                                        {% else %}
                                        <button class="btn btn-sm btn-secondary" disabled title="Admin tidak boleh dipadam"><i class="fas fa-lock"></i></button>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailPenggunaModal" tabindex="-1" aria-labelledby="detailPenggunaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="detailPenggunaModalLabel">Detail Pengguna</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detailPenggunaBody">
                </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts_extra %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const detailPenggunaModal = document.getElementById('detailPenggunaModal');

    detailPenggunaModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const penggunaId = button.getAttribute('data-pengguna-id');
        const modalBody = document.getElementById('detailPenggunaBody');
        const modalTitle = document.getElementById('detailPenggunaModalLabel');

        modalBody.innerHTML = '<p class="text-center"><i>Memuatkan maklumat...</i></p>';
        modalTitle.textContent = 'Detail Pengguna';

        fetch(`/get_pengguna_details/${penggunaId}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    modalBody.innerHTML = `<p class="text-danger">${data.error}</p>`;
                } else {
                    modalTitle.textContent = `Detail untuk ${data.nama}`;
                    modalBody.innerHTML = `
                        <dl class="row">
                            <dt class="col-sm-4">ID Pengguna</dt>
                            <dd class="col-sm-8">${data.id}</dd>
                            <dt class="col-sm-4">Nama Penuh</dt>
                            <dd class="col-sm-8">${data.nama}</dd>
                            <dt class="col-sm-4">Username</dt>
                            <dd class="col-sm-8">${data.username}</dd>
                            <dt class="col-sm-4">Nombor Telefon</dt>
                            <dd class="col-sm-8">${data.telefon || '-'}</dd>
                            <dt class="col-sm-4">Peranan</dt>
                            <dd class="col-sm-8"><span class="badge bg-primary">${data.peranan.charAt(0).toUpperCase() + data.peranan.slice(1)}</span></dd>
                        </dl>
                    `;
                }
            })
            .catch(error => {
                modalBody.innerHTML = '<p class="text-danger">Gagal memuatkan data. Sila cuba lagi.</p>';
                console.error('Error:', error);
            });
    });
});
</script>
{% endblock %}